name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g. v0.1.6)'
        required: true
        type: string
        default: 'v0.1.6'

env:
  RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

permissions:
  contents: write

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Mandrid ${{ env.RELEASE_TAG }}
          generate_release_notes: true

  publish:
    name: Publish for ${{ matrix.os }}
    needs: release
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    env:
      CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: mem
            asset_name: mandrid-linux-amd64
          - os: windows-latest
            artifact_name: mem.exe
            asset_name: mandrid-windows-amd64.exe

    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4
      
      - name: Install Nix
        if: matrix.os != 'windows-latest'
        uses: cachix/install-nix-action@v30
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Cachix
        if: matrix.os != 'windows-latest'
        uses: cachix/cachix-action@v15
        with:
          name: mandrid
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Verify Cachix token presence
        if: matrix.os != 'windows-latest'
        run: |
          if [ -z "${CACHIX_AUTH_TOKEN:-}" ]; then
            echo "CACHIX_AUTH_TOKEN: empty"
          else
            echo "CACHIX_AUTH_TOKEN: set"
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Sanitize linker PATH (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $paths = $env:Path -split ';'
          $filtered = $paths | Where-Object { $_ -notmatch 'Git\\usr\\bin' }
          $newPath = ($filtered -join ';')
          "PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER=link.exe" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Pin MSVC linker path (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $msvc = $env:VCToolsInstallDir
          if (-not $msvc) {
            $msvc = $env:VCINSTALLDIR
          }
          if (-not $msvc) {
            throw "MSVC environment not available (VCToolsInstallDir/VCINSTALLDIR missing)"
          }
          $linkerDir = Join-Path $msvc "bin\Hostx64\x64"
          $linker = Join-Path $linkerDir "link.exe"
          if (-not (Test-Path $linker)) { throw "MSVC link.exe not found" }
          "CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER=$linker" | Out-File -FilePath $env:GITHUB_ENV -Append
          "PATH=$linkerDir;$env:Path" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build with Nix (Linux/macOS)
        if: matrix.os != 'windows-latest'
        env:
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
        run: |
          if [ -z "$CACHIX_AUTH_TOKEN" ]; then
            echo "Warning: CACHIX_AUTH_TOKEN is not set. Skipping Cachix push."
            SKIP_CACHIX_PUSH=1
          fi
          nix build .#mandrid
          # Get the closure of the build result and push it all explicitly
          if [ -z "${SKIP_CACHIX_PUSH:-}" ]; then
            echo "Pushing store paths to Cachix..."
            nix path-info --recursive .#mandrid | cachix push mandrid
          fi

      - name: Build with Cargo (all platforms)
        run: cargo build --locked --release

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: target/release/${{ matrix.artifact_name }}
          asset_name: ${{ matrix.asset_name }}
          tag: ${{ env.RELEASE_TAG }}
          overwrite: true
