<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandrid Memory Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; }
        .memory-card:hover { background: #1e293b; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8 border-b border-slate-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Mandrid Portal</h1>
                <p class="text-slate-400 text-sm">Local-first AI Memory Dashboard</p>
            </div>
            <div class="text-right">
                <span id="status-badge" class="px-2 py-1 bg-green-900 text-green-300 text-xs rounded border border-green-700">Connected</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sidebar: Filters and Stats -->
            <div class="space-y-6">
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <h2 class="font-semibold mb-4 text-slate-200">Stats</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-900 p-3 rounded">
                            <div class="text-xs text-slate-500 uppercase">Total</div>
                            <div id="stat-total" class="text-xl font-bold text-blue-300">0</div>
                        </div>
                        <div class="bg-slate-900 p-3 rounded">
                            <div class="text-xs text-slate-500 uppercase">Tasks</div>
                            <div id="stat-tasks" class="text-xl font-bold text-orange-300">0</div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <h2 class="font-semibold mb-4 text-slate-200">Search</h2>
                    <input type="text" id="search-input" placeholder="Search memories..." 
                        class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm focus:outline-none focus:border-blue-500">
                </div>
            </div>

            <!-- Main Content: Memory List -->
            <div class="lg:col-span-2 space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-slate-200">Recent Memories</h2>
                    <button id="refresh-btn" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition">Refresh</button>
                </div>
                <div id="memory-container" class="space-y-4">
                    <!-- Memories will be injected here -->
                    <div class="animate-pulse flex space-x-4 p-4 bg-slate-800 rounded-lg">
                        <div class="flex-1 space-y-4 py-1">
                            <div class="h-4 bg-slate-700 rounded w-3/4"></div>
                            <div class="space-y-2">
                                <div class="h-4 bg-slate-700 rounded"></div>
                                <div class="h-4 bg-slate-700 rounded w-5/6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inspector Modal -->
    <div id="inspector-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-xl max-w-4xl w-full max-h-[90vh] flex flex-col shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 id="inspector-title" class="font-bold text-blue-300">Memory Details</h3>
                <button onclick="closeInspector()" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <div class="p-6 overflow-y-auto font-mono text-sm space-y-4">
                <div>
                    <span class="text-slate-500">Content:</span>
                    <pre id="inspector-content" class="mt-2 bg-slate-900 p-4 rounded text-slate-300 whitespace-pre-wrap border border-slate-700"></pre>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="text-slate-500 block mb-1">Metadata:</span>
                        <div id="inspector-meta" class="bg-slate-900 p-3 rounded text-xs text-slate-400 border border-slate-700 space-y-1"></div>
                    </div>
                    <div>
                        <span class="text-slate-500 block mb-1">References:</span>
                        <div id="inspector-refs" class="bg-slate-900 p-3 rounded text-xs text-blue-400 border border-slate-700"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allMemories = [];

        async function fetchMemories() {
            try {
                const response = await fetch('/api/memories');
                const data = await response.json();
                allMemories = data;
                renderMemories(data);
                updateStats(data);
            } catch (err) {
                console.error('Failed to fetch memories:', err);
                document.getElementById('status-badge').textContent = 'Error';
                document.getElementById('status-badge').className = 'px-2 py-1 bg-red-900 text-red-300 text-xs rounded border border-red-700';
            }
        }

        function renderMemories(memories) {
            const container = document.getElementById('memory-container');
            if (memories.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-center py-8">No memories found. Run some commands or index code!</div>';
                return;
            }

            container.innerHTML = memories.map((m, idx) => `
                <div onclick="inspectMemory(${idx})" class="memory-card bg-slate-800 p-4 rounded-lg border border-slate-700 cursor-pointer transition shadow-sm group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded ${getTypeColor(m.memory_type)}">
                            ${m.memory_type}
                        </span>
                        <span class="text-[10px] text-slate-500 font-mono">${new Date(m.created_at * 1000).toLocaleString()}</span>
                    </div>
                    <div class="text-sm font-medium text-slate-200 mb-2 truncate group-hover:text-blue-300 transition-colors">
                        ${m.name || (m.tag && m.tag.replace('code:', '')) || 'Memory'}
                    </div>
                    <div class="text-xs text-slate-400 line-clamp-2 font-mono bg-slate-900/50 p-2 rounded">
                        ${escapeHtml(m.text.substring(0, 200))}
                    </div>
                    ${m.references && m.references !== '[]' ? `
                        <div class="mt-2 flex gap-1 flex-wrap">
                            ${JSON.parse(m.references).slice(0, 3).map(r => `
                                <span class="text-[9px] bg-blue-900/30 text-blue-400 px-1.5 py-0.5 rounded border border-blue-800/50">${r}</span>
                            `).join('')}
                            ${JSON.parse(m.references).length > 3 ? '<span class="text-[9px] text-slate-500">...</span>' : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function getTypeColor(type) {
            switch(type) {
                case 'code': return 'bg-blue-900 text-blue-300 border border-blue-700';
                case 'task': return 'bg-orange-900 text-orange-300 border border-orange-700';
                case 'trace': return 'bg-purple-900 text-purple-300 border border-purple-700';
                case 'git_reasoning': return 'bg-green-900 text-green-300 border border-green-700';
                default: return 'bg-slate-700 text-slate-300 border border-slate-600';
            }
        }

        function updateStats(memories) {
            document.getElementById('stat-total').textContent = memories.length;
            document.getElementById('stat-tasks').textContent = memories.filter(m => m.memory_type === 'task').length;
        }

        function inspectMemory(idx) {
            const m = allMemories[idx];
            document.getElementById('inspector-title').textContent = m.tag || m.memory_type;
            document.getElementById('inspector-content').textContent = m.text;
            
            document.getElementById('inspector-meta').innerHTML = `
                <div><span class="text-slate-600">File:</span> ${m.file_path}:${m.line_start}</div>
                <div><span class="text-slate-600">Session:</span> ${m.session_id}</div>
                <div><span class="text-slate-600">Created:</span> ${new Date(m.created_at * 1000).toLocaleString()}</div>
                <div><span class="text-slate-600">Status:</span> ${m.status}</div>
            `;

            const refs = JSON.parse(m.references || '[]');
            document.getElementById('inspector-refs').innerHTML = refs.length > 0 
                ? refs.map(r => `<div class="mb-1">→ ${r}</div>`).join('')
                : 'No references extracted';

            document.getElementById('inspector-modal').classList.remove('hidden');
        }

        function closeInspector() {
            document.getElementById('inspector-modal').classList.add('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Search logic
        document.getElementById('search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allMemories.filter(m => 
                m.text.toLowerCase().includes(query) || 
                (m.tag && m.tag.toLowerCase().includes(query)) ||
                (m.name && m.name.toLowerCase().includes(query))
            );
            renderMemories(filtered);
        });

        document.getElementById('refresh-btn').addEventListener('click', fetchMemories);

        // Initial fetch
        fetchMemories();
        // Auto-refresh every 10s
        setInterval(fetchMemories, 10000);
    </script>
</body>
</html>